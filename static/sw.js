!function(){Array.prototype.find||Object.defineProperty(Array.prototype,"find",{value:function(e){if(null==this)throw new TypeError('"this" is null or not defined');var t=Object(this),n=t.length>>>0;if("function"!=typeof e)throw new TypeError("predicate must be a function");for(var r=arguments[1],o=0;o<n;){var i=t[o];if(e.call(r,i,o,t))return i;o++}}}),Array.prototype.includes||Object.defineProperty(Array.prototype,"includes",{value:function(e,t){if(null==this)throw new TypeError('"this" is null or not defined');var n=Object(this),r=n.length>>>0;if(0===r)return!1;for(var o,i,a=0|t,c=Math.max(a>=0?a:r-Math.abs(a),0);c<r;){if((o=n[c])===(i=e)||"number"==typeof o&&"number"==typeof i&&isNaN(o)&&isNaN(i))return!0;c++}return!1}}),Array.prototype.some||(Array.prototype.some=function(e){if(null==this)throw new TypeError("Array.prototype.some called on null or undefined");if("function"!=typeof e)throw new TypeError;for(var t=Object(this),n=t.length>>>0,r=arguments.length>=2?arguments[1]:void 0,o=0;o<n;o++)if(o in t&&e.call(r,t[o],o,t))return!0;return!1}),Array.prototype.findIndex||Object.defineProperty(Array.prototype,"findIndex",{value:function(e){if(null==this)throw new TypeError('"this" is null or not defined');var t=Object(this),n=t.length>>>0;if("function"!=typeof e)throw new TypeError("predicate must be a function");for(var r=arguments[1],o=0;o<n;){var i=t[o];if(e.call(r,i,o,t))return o;o++}return-1}}),Array.prototype.reduce||Object.defineProperty(Array.prototype,"reduce",{value:function(e){if(null===this)throw new TypeError("Array.prototype.reduce called on null or undefined");if("function"!=typeof e)throw new TypeError(e+" is not a function");var t,n=Object(this),r=n.length>>>0,o=0;if(arguments.length>=2)t=arguments[1];else{for(;o<r&&!(o in n);)o++;if(o>=r)throw new TypeError("Reduce of empty array with no initial value");t=n[o++]}for(;o<r;)o in n&&(t=e(t,n[o],o,n)),o++;return t}});var e=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},t=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},r=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var n=[],r=!0,o=!1,i=void 0;try{for(var a,c=e[Symbol.iterator]();!(r=(a=c.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(e){o=!0,i=e}finally{try{!r&&c.return&&c.return()}finally{if(o)throw i}}return n}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();function o(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments[1];return e.reduce(function(e,t){return e.then(t)},Promise.resolve(t))}function i(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=t.request,r=t.cachedResponse;return o(e.map(function(e){var t=e.beforeResponse,r=void 0===t?function(e){return Promise.resolve(e)}:t;return function(e){return r(n,e)}}),r)}var a=function(){function n(){e(this,n)}return t(n,[{key:"beforeCache",value:function(e,t){return t}},{key:"beforeResponse",value:function(e,t){return t}},{key:"cacheDidUpdate",value:function(e){}}]),n}(),c="pre-cache:",s="runtime-cache";function u(e,t,n){var r=e.url,o=n.cacheName,i=void 0===o?s:o,a=n.cacheOptions,c=(void 0===a?{}:a).ignoreSearch?r.split("?")[0]:r;return caches.open(i).then(function(e){return self.isIos?e.add(c).then(function(){return t}):e.put(c,t.clone()).then(function(){return t})})}function h(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=t.cacheName,r=t.matchOptions,o=void 0===r?{}:r,i=n?caches.open(n):Promise.resolve(caches);return i.then(function(t){return t.match((n=e.url,o.ignoreSearch?n.split("?")[0]:n)).then(function(e){if(e)return e;throw new Error("no match cache")});var n})}function f(e){var t=(arguments.length>1&&void 0!==arguments[1]?arguments[1]:{}).fetchOptions;return fetch(e,t).then(function(e){if(200!==e.status){var t=new Error("Fetch Failed");throw t.response=e,t}return e})}function l(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.cacheName,n=e.fetchOptions,r=e.matchOptions,o=arguments[1];return function(e){var a=e.request;return h(a,{cacheName:t,matchOptions:r}).then(function(e){return i(o,{request:a,cachedResponse:e})}).catch(function(){return function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=t.fetchOptions,r=t.cacheName,o=void 0===r?s:r,i=t.cacheOptions;return f(e,n).then(function(t){return u(e,t,{cacheName:o,cacheOptions:i}).catch(function(e){console.log("cacheResponse error",e.message)}),t})}(a,{fetchOptions:n,cacheName:t})})}}function p(e,t,n){return e.arrayBuffer().then(function(t){var r=function(e,t,n){var r=e.byteLength;if(n&&n>r||t&&t<0)throw new Error("range-not-satisfiable:"+{size:r,end:n,start:t});var o=void 0,i=void 0;return void 0!==t&&void 0!==n?(o=t,i=n+1):void 0!==t&&void 0===n?(o=t,i=r):void 0!==n&&void 0===t&&(o=r-n,i=r),{start:o,end:i}}(t,n.start,n.end),o=t.slice(r.start,r.end),i=o.byteLength,a=new Response(o,{status:206,statusText:"Partial Content",headers:e.headers});return a.headers.set("status","206"),a.headers.set("content-length",String(i)),a.headers.set("content-range","bytes "+r.start+"-"+(r.end-1)+"/"+t.byteLength),a})}function d(e,t){if(206===t.status)return t;var n=e.headers.get("range");if(!n)throw new Error("no range header");return p(t,0,function(e){var t=e.trim().toLowerCase();if(!t.startsWith("bytes="))throw new Error("unit-must-be-bytes "+t);if(t.includes(","))throw new Error("single-range-only:"+t);var n=/(\d*)-(\d*)/.exec(t);if(!n||!n[1]&&!n[2])throw new Error("invalid-range-values:"+t);return{start:""===n[1]?void 0:Number(n[1]),end:""===n[2]?void 0:Number(n[2])}}(n))}var v=function(r){function o(){return e(this,o),n(this,(o.__proto__||Object.getPrototypeOf(o)).apply(this,arguments))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(o,a),t(o,[{key:"beforeResponse",value:function(e,t){try{return t&&e.headers.get("range")&&self.isSafari?d(e,t):t}catch(e){return Promise.reject(e)}}}]),o}();var y=function(){function n(t){e(this,n),this.pages=[],this.resources=[],this.router=t,this.initEventListener()}return t(n,[{key:"initEventListener",value:function(){self.addEventListener("activate",function(){console.log("####activate####"),self.clients.claim()})}},{key:"precache",value:function(e){return function(e){return Promise.all(e.map(function(e){var t=e.url,n=e.assets,r=void 0===n?[]:n;return caches.open(c+t).then(function(e){return Promise.all(r.map(function(t){return e.match(t).then(function(n){if(!n)return e.add(t).catch(function(){})})}))})}))}(e)}},{key:"addRoute",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=arguments[1];this.pages=t,t&&0===t.length&&(this.resources=[]);for(var r=0;r<t.length;r++){var o=t[r].assets;this.resources=this.resources.concat(o)}var i=l({matchOptions:n,fetchOptions:{credentials:"same-origin",mode:"cors"}},[new v]);this.router.registerRoute("precacheRoute",function(t){return e.resources.some(function(e){return e===t.url})},function(t){return!!e.resources.find(function(e){return e===t.url})&&i(t)})}},{key:"precacheAndRoute",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments[1];return this.addRoute(e,t),this.precache(e)}},{key:"clearExpireCache",value:function(){return e=this.pages,t=e.map(function(e){return c+e.url}),caches.keys().then(function(e){return Promise.all(e.map(function(e){return!t.includes(e)&&e.startsWith(c)?caches.delete(e):Promise.resolve("no caches to delete")}))});var e,t}}]),n}();function m(e,t){switch(Object.prototype.toString.call(e)){default:return!1;case"[object String]":return t.url===e;case"[object RegExp]":return t.url.match(e);case"[object Function]":return e(t)}}function g(e,t){try{var n=t(e);if(n instanceof Promise){var r=n.then(function(e){if(!(e instanceof Response))throw Error("返回结果异常");return e}).catch(function(t){return t.response||fetch(e.request.clone())}).catch(function(){});return void e.respondWith(r)}n instanceof Response&&e.respondWith(n)}catch(e){console.log(e)}}var b=function(){function n(t){e(this,n),this.useProxy=!0,this.routes=[],this.initEventListener(t)}return t(n,[{key:"initEventListener",value:function(e){var t=this;try{self.addEventListener("install",function(t){console.log("####install####"),t.waitUntil(e&&e(t))}),self.addEventListener("fetch",function(e){if(console.log("fetch routes.length",t.routes.length),t.useProxy)for(var n=0;n<t.routes.length;n++){var r=t.routes[n];if(m(r.rule,e.request)&&e.request.url.startsWith("https:")){g(e,r.handler);break}}})}catch(e){console.log("initEventListenerError",e)}}},{key:"registerRoute",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"route-cache",t=arguments[1],n=arguments[2];this.unRegisterRoute(e),this.routes.push({ruleName:e,rule:t,handler:n})}},{key:"unRegisterRoute",value:function(e){var t=this.routes.findIndex(function(t){return t.ruleName===e});-1!==t&&this.routes.splice(t,1)}},{key:"setProxy",value:function(e){this.useProxy=e}}]),n}();function w(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.fetchOptions,n=e.cacheName,r=void 0===n?s:n,a=e.matchOptions,c=e.cacheOptions,l=arguments[1];return function(e){var n=e.request,s=f(e.request,{fetchOptions:t}),p=function(e,t){var n=t.cacheName,r=t.matchOptions;return h(e,{cacheName:n,matchOptions:r}).catch(function(){return h(e,{matchOptions:r})})}(n,{cacheName:r,matchOptions:a});return s.then(function(e){return function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=t.request,r=t.response;return o(e.map(function(e){var t=e.beforeCache,r=void 0===t?function(e){return Promise.resolve(e)}:t;return function(e){return r(n,e)}}),r)}(l,{request:n,response:e})}).then(function(t){return u(e.request,t,{cacheName:r,cacheOptions:c})}).then(function(e){return p.then(function(t){return{oldResponse:t,newResponse:e}})}).then(function(t){var n=t.newResponse,o=t.oldResponse;return function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments[1];e.map(function(e){return(0,e.cacheDidUpdate)(t)})}(l,{cacheName:r,fetchEvent:e,newResponse:n,oldResponse:o})}),p.then(function(e){return i(l,{request:n,cachedResponse:e})}).catch(function(){return s})}}var x={"zh-cn":/^zh-cn/i,"zh-tw":/^zh-tw/i,"en-us":/^en\b/i,"fr-fr":/^fr\b/i,"de-de":/^de\b/i,"es-es":/^es\b/i,"pt-pt":/^pt\b/i,"ru-ru":/^ru\b/i,"ja-jp":/^ja\b/i,"ko-kr":/^ko\b/i,"th-th":/^th\b/i,"vi-vn":/^vi\b/i,"id-id":/^id\b/i};function O(e){for(var t=location.search.substring(1).split("&"),n=0;n<t.length;n++){var r=t[n].split("=");if(r[0]===e)return decodeURIComponent?decodeURIComponent(r[1]):r[1]}return null}function R(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=arguments[1];return"string"==typeof e&&"string"==typeof t&&e.toLowerCase().includes(t.toLowerCase())}var E=O("platform"),j=O("network")||"WiFi";function k(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.enable,n=e.load_limit,r=void 0===n?3:n,o=e.pages,i=void 0===o?[]:o,a=(new Date).getTime(),c=i.map(function(e){return e.assets=e.res_list.map(function(e){return encodeURI(e)}),e}).filter(function(e){return function(e){return R(e.platform,E)}(e)&&function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.end_time,n=void 0===t?"":t,r=e.start_time,o=void 0===r?"":r,i=new Date(n.replace(/-/g,"/")).getTime(),c=new Date(o.replace(/-/g,"/")).getTime();return a<i&&a>=c}(e)}),s=c.filter(function(e){return function(e){return R(e.network,j)}(e)});return t?caches.keys().then(function(e){return{precachePages:s.filter(function(t){return!!e.includes(t.url)||--r>=0}),routePages:c,enable:t}}):{precachePages:[],routePages:c,enable:t}}function P(){return"[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0)?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{}}var N,S,T,A,L=(N=Date.now(),S=0,T={now:function(){var e=Date.now()-N;return e<S&&(e=S),S=e,e},timeOrigin:N},(A=P().performance)&&A.now?(void 0===A.timeOrigin&&(A.timeOrigin=A.timing&&A.timing.navigationStart||N),A):T);function q(){return(L.timeOrigin+L.now())/1e3}var C=new(function(){function n(){e(this,n)}return t(n,[{key:"init",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.dsn=e.dsn,this.createApi(),this.globalObject=P(),this.proxyFetch(),this.initEventListener(),this.isSea="webstatic-sea.mihoyo.com"===location.href,this.isTest="webstatic-sea-test.mihoyo.com"===location.href||"webstatic-test.mihoyo.com"===location.href}},{key:"initEventListener",value:function(){var e=this;self.addEventListener("error",function(t){e.captureException(t.error)})}},{key:"proxyFetch",value:function(){var e=this;this.globalObject.originalFetch=this.globalObject.fetch;var t=function(t,n){return e.globalObject.originalFetch(t,n).then(function(e){if(e.status>=300||e.status<200)throw new TypeError("proxyFetch:Failed to fetch，status："+e.status);return e}).catch(function(r){var o=new TypeError("proxyFetch:"+r.message);throw e.captureException(o,{fetchInfo:{url:t.url||t,method:n?n.method:"GET"}}),r})};this.globalObject.fetch=t}},{key:"createApi",value:function(){var e=this.dsn.split("https://")[1].split("@sentry.mihoyo.com/"),t=r(e,2),n=t[0],o=t[1],i=this.isSea?"https://sentry-sea.mihoyo.com":"https://sentry.mihoyo.com";this.api=i+"/api/"+o+"/store/?sentry_key="+n+"&sentry_version=7"}},{key:"postException",value:function(e){if(!this.isTest)return this.globalObject.originalFetch(this.api,{method:"post",headers:{accept:"*/*","accept-language":"zh-CN,zh;q=0.9,en;q=0.8","content-type":"text/plain;charset=UTF-8","sec-fetch-dest":"empty","sec-fetch-mode":"cors","sec-fetch-site":"cross-site"},body:JSON.stringify(e)}).catch(function(){})}},{key:"createData",value:function(e,t){var n=t.fetchInfo,o=this.globalObject,i=o.navigator,a=o.location,c=i?i.userAgent:"unknown ua",s=a?a.href:"unknown url",u=function(){var e=P(),t=e.crypto||e.msCrypto;if(void 0!==t&&t.getRandomValues){var n=new Uint16Array(8);t.getRandomValues(n),n[3]=4095&n[3]|16384,n[4]=16383&n[4]|32768;var r=function(e){for(var t=e.toString(16);t.length<4;)t="0"+t;return t};return r(n[0])+r(n[1])+r(n[2])+r(n[3])+r(n[4])+r(n[5])+r(n[6])+r(n[7])}return"xxxxxxxxxxxx4xxxyxxxxxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}(),h=[];if(n){var f=n.method,l=n.url,p=(void 0===l?"":l).split("?"),d=r(p,1)[0],v=Object.prototype.toString.call(d);"[object String]"!==v&&(d="unknown request url;url type:"+v),h.push({timestamp:q(),category:"fetch",data:{method:(f||"get").toLocaleUpperCase(),url:d},level:"error",type:"http"})}return{event_id:u,request:{headers:{"User-Agent":c},url:s},exception:{values:[{type:e.name,value:e.message,mechanism:{handled:!0,type:"generic"}}]},breadcrumbs:h,level:"error",platform:"javascript",timeStamp:q()}}},{key:"captureException",value:function(e){var t=(arguments.length>1&&void 0!==arguments[1]?arguments[1]:{}).fetchInfo,n=this.createData(e,{fetchInfo:t});this.postException(n)}}]),n}());C.init({dsn:"https://690b1e8e41244bb1aafa7bf1b7ef559e@sentry.mihoyo.com/23"}),console.log("###worker start###",self);try{var _=self.navigator?self.navigator.userAgent:"Safari";self.isSafari=(/Safari/i.test(_)||!!_.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/))&&!/Chrome/i.test(_),self.isIos=/ios/i.test(O("platform"));var F=O("gameBiz"),I=O("lang");F.endsWith("_cn")&&(I="zh-cn");var U=function(e){return Object.keys(x).find(function(t){return x[t].test(e)})||"zh-cn"}(I),z=1e3*Math.floor((new Date).getTime()/1e4)*10,D=location.origin+"/admin/swpreload/"+F+"/"+U+".json?timestamp="+z,W=new b,M=new y(W);W.registerRoute("htmlRoute",function(e){var t=e.url.split("?")[0].split("#")[0];return/.*\.html$/.test(t)&&!/\/sw.html$/.test(t)},w({cacheName:s,matchOptions:{ignoreSearch:!0},cacheOptions:{ignoreSearch:!0}})),W.registerRoute("jsonRoute",/https:\/\/webstatic(-sea)?(-test)?.mihoyo.com\/.*\.json(\?.*)?$/,w({cacheName:s})),W.registerRoute("precacheRoute",/https:\/\/webstatic(-sea)?(-test)?.mihoyo.com\/.*\.(js|css|png|jpe?g|gif)(\?.*)?$/,l({fetchOptions:{mode:"cors",credentials:"same-origin"}}));fetch(D).then(function(e){return e.json()}).then(k).then(function(e){var t=e.precachePages,n=e.routePages,r=e.enable;return W.setProxy(r),W.unRegisterRoute("precacheRoute"),t&&t.length?M.precacheAndRoute(t):M.addRoute(n)}).catch(function(e){throw W.unRegisterRoute("precacheRoute"),M.addRoute([]),e}).then(function(){return M.clearExpireCache()}).then(self.skipWaiting).catch(function(e){return C.captureException(e)})}catch(e){throw"ios"===O("platform")&&C.captureException(e),e}}();

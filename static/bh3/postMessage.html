<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>postMessage</title>
</head>
<body>
<div id="content"></div>
<br/>
<div id="serviceWorker"></div>
<br/>
<div id="controller"></div>
<br/>
<div id="state"></div>
<script>
    var content = document.getElementById('content');
    var serviceWorker = document.getElementById('serviceWorker');
    var controller = document.getElementById('controller');
    var state = document.getElementById('state');
    content.innerHTML = new Date().getTime() + ''

    serviceWorker.innerHTML = 'navigator.serviceWorker:' + navigator.serviceWorker
    controller.innerHTML = 'controller:' + navigator.serviceWorker.controller
    state.innerHTML = 'state:' + navigator.serviceWorker.controller.state

    if ('serviceWorker' in navigator) {
        content.innerHTML = "has serviceWorker";
        navigator.serviceWorker.ready
            .then(function(registration) {
                content.innerHTML = "A service worker is active" + registration.active;
                navigator.serviceWorker.addEventListener("message", receiveMessage);
            });
    } else {
        content.innerHTML = "Service workers are not supported.";
    }

    navigator.serviceWorker.addEventListener("message", receiveMessage);

    function receiveMessage(event) {
        // For Chrome, the origin property is in the event.originalEvent
        // object.
        // 这里不准确，chrome没有这个属性
        // var origin = event.origin || event.originalEvent.origin;
        console.log('receiveMessage', event.data)
        if (event.data.meta === 'mihoyo-sw-broadcast-update') {
            console.log('mihoyo-sw-broadcast-update');
            content.innerHTML = JSON.stringify(event.data.payload);
        }
    }

    setTimeout(function() {
        navigator.serviceWorker.addEventListener("messageA", receiveMessage);
    }, 2);

    setTimeout(function() {
        navigator.serviceWorker.addEventListener("messageB", function(e){});
    }, 5);
</script>
</body>
</html>
